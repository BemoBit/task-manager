# Pipeline System Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Task Manager System                          │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                            Frontend                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │   Dashboard  │  │   Pipeline   │  │   Subtasks   │              │
│  │   View       │  │   Monitor    │  │   List       │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│           │                │                │                        │
│           └────────────────┴────────────────┘                        │
│                          │                                           │
│                  REST API + WebSocket                                │
└──────────────────────────┼───────────────────────────────────────────┘
                           │
┌──────────────────────────┼───────────────────────────────────────────┐
│                    NestJS Backend                                    │
│                          │                                           │
│  ┌──────────────────────┴────────────────────────┐                  │
│  │         Pipeline Controller (REST)             │                  │
│  │  POST /start  GET /state  PATCH /pause         │                  │
│  └────────────┬──────────────┬────────────────────┘                  │
│               │              │                                       │
│  ┌────────────▼──────────────▼────────────────────┐                  │
│  │          Pipeline Service                      │                  │
│  │  • Orchestration  • Checkpoints  • Recovery   │                  │
│  └────────────┬──────────────┬────────────────────┘                  │
│               │              │                                       │
│  ┌────────────▼──────┐  ┌───▼────────────────────┐                  │
│  │  State Machine    │  │  Pipeline Gateway      │                  │
│  │  Service          │  │  (WebSocket)           │                  │
│  │  • Transitions    │  │  • Real-time events    │                  │
│  │  • Validation     │  │  • Subscriptions       │                  │
│  └────────────────────┘  └────────────────────────┘                  │
│               │                     │                                │
│  ┌────────────▼─────────────────────▼──────────────┐                │
│  │            BullMQ Queue System                   │                │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐      │                │
│  │  │ Pipeline │  │Decompose │  │ Enrich   │      │                │
│  │  │  Queue   │  │  Queue   │  │  Queue   │      │                │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘      │                │
│  │       │             │             │             │                │
│  │  ┌────▼─────┐  ┌────▼─────┐  ┌────▼─────┐      │                │
│  │  │ Pipeline │  │Decompose │  │ Enrich   │      │                │
│  │  │Processor │  │Processor │  │Processor │      │                │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘      │                │
│  │       │             │             │             │                │
│  └───────┼─────────────┼─────────────┼─────────────┘                │
│          │             │             │                              │
│  ┌───────▼─────────────▼─────────────▼─────────────┐                │
│  │           Prisma ORM (Database Access)          │                │
│  └───────────────────────┬──────────────────────────┘                │
└──────────────────────────┼───────────────────────────────────────────┘
                           │
┌──────────────────────────┼───────────────────────────────────────────┐
│                   Infrastructure                                     │
│                          │                                           │
│  ┌───────────────────────▼──────────────┐  ┌──────────────────────┐ │
│  │        PostgreSQL Database           │  │      Redis           │ │
│  │  ┌────────────────────────────┐      │  │  • Queue Backend     │ │
│  │  │ Tables:                    │      │  │  • Cache             │ │
│  │  │ • pipelines                │      │  │  • Session Store     │ │
│  │  │ • pipeline_phase_executions│      │  └──────────────────────┘ │
│  │  │ • pipeline_checkpoints     │      │                           │
│  │  │ • pipeline_events          │      │                           │
│  │  │ • tasks                    │      │                           │
│  │  │ • subtasks                 │      │                           │
│  │  └────────────────────────────┘      │                           │
│  └──────────────────────────────────────┘                           │
└──────────────────────────────────────────────────────────────────────┘
```

## Pipeline Execution Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Pipeline Execution Flow                          │
└─────────────────────────────────────────────────────────────────────┘

                           START PIPELINE
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │   State: IDLE          │
                    └────────────┬───────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │ State: INITIALIZING    │
                    │ • Validate task        │
                    │ • Create pipeline ID   │
                    │ • Queue pipeline job   │
                    └────────────┬───────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │ State: DECOMPOSING     │◄──────────┐
                    └────────────┬───────────┘           │
                                 │                       │
                    ┌────────────▼───────────┐           │
                    │ Decomposition Queue    │           │
                    │ • Parse task           │           │
                    │ • Generate subtasks    │           │
                    │ • Store in DB          │           │
                    └────────────┬───────────┘           │
                                 │                       │
                                 ▼                       │
                    ┌────────────────────────┐           │
                    │ CREATE CHECKPOINT #1   │           │
                    │ • Save state           │           │
                    │ • Save subtasks        │    Rollback Support
                    └────────────┬───────────┘           │
                                 │                       │
                                 ▼                       │
                    ┌────────────────────────┐           │
                    │ State: ENRICHING       │◄──────────┤
                    └────────────┬───────────┘           │
                                 │                       │
                    ┌────────────▼───────────┐           │
                    │ Enrichment Queue       │           │
                    │ • Add tech stack       │           │
                    │ • Add standards        │           │
                    │ • Add best practices   │           │
                    │ • Update DB            │           │
                    └────────────┬───────────┘           │
                                 │                       │
                                 ▼                       │
                    ┌────────────────────────┐           │
                    │ CREATE CHECKPOINT #2   │           │
                    │ • Save enriched data   │           │
                    └────────────┬───────────┘           │
                                 │                       │
                                 ▼                       │
                    ┌────────────────────────┐           │
                    │ State: GENERATING      │◄──────────┘
                    │ PROMPTS                │
                    └────────────┬───────────┘
                                 │
                    ┌────────────▼───────────┐
                    │ Prompt Generation      │
                    │ • Group by category    │
                    │ • Format prompts       │
                    │ • Include context      │
                    └────────────┬───────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │ State: COMPLETED       │
                    │ • Save results         │
                    │ • Emit events          │
                    │ • Cleanup              │
                    └────────────────────────┘

                         Pipeline Complete!
```

## State Machine Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Pipeline State Machine                          │
└─────────────────────────────────────────────────────────────────────┘

                              ┌──────┐
                              │ IDLE │
                              └───┬──┘
                                  │ start
                                  ▼
                         ┌────────────────┐
                         │ INITIALIZING   │
                         └────┬───────────┘
                              │
                    ┌─────────┼─────────┐
                    │ success │ error   │
                    ▼         ▼         ▼
         ┌──────────────┐  ┌──────┐  ┌────────┐
         │ DECOMPOSING  │  │PAUSED│  │ FAILED │
         └──────┬───────┘  └──┬───┘  └───┬────┘
                │             │          │
      ┌─────────┼─────────┐   │          │
      │ success │ error   │   │          │
      ▼         ▼         ▼   │          │
┌──────────┐  ┌──────┐  ┌────────┐      │
│ENRICHING │  │PAUSED│  │ FAILED │      │
└────┬─────┘  └──┬───┘  └───┬────┘      │
     │           │          │           │
 ┌───┼───────┐   │          │           │
 │ success   │   │          │           │
 ▼   ▼       ▼   │          │           │
┌─────────┐ ┌──────┐ ┌────────┐         │
│GENERATING│ │PAUSED│ │ FAILED │         │
│ PROMPTS  │ └──┬───┘ └───┬────┘         │
└────┬────┘    │         │              │
     │         │         │              │
     │ success │         │              │
     ▼         │         │              │
┌───────────┐  │         │              │
│ COMPLETED │  │         │              │
└───────────┘  │         │              │
               │         │              │
               │         ▼              │
               │    ┌──────────────┐    │
               └────┤ ROLLED_BACK  │◄───┘
                    └──────┬───────┘
                           │
                           ▼
                        ┌──────┐
                        │ IDLE │
                        └──────┘
```

## Component Interaction

```
┌─────────────────────────────────────────────────────────────────────┐
│                   Component Interaction Flow                         │
└─────────────────────────────────────────────────────────────────────┘

     Client                Controller         Service         Queue
       │                       │                 │              │
       │  POST /start          │                 │              │
       ├──────────────────────►│                 │              │
       │                       │ startPipeline() │              │
       │                       ├────────────────►│              │
       │                       │                 │ validate     │
       │                       │                 │ transition   │
       │                       │                 │ createJob    │
       │                       │                 ├─────────────►│
       │                       │                 │              │
       │  { pipelineId }       │                 │              │
       │◄──────────────────────┤                 │              │
       │                       │                 │              │
       │                       │                 │              │
       │  ws://subscribe       │                 │    Worker    │
       ├───────────────────────┼─────────────────┼──────┐       │
       │                       │                 │      │       │
       │                       │                 │      │ process
       │                       │                 │      ├──────►│
       │                       │                 │      │       │
       │   pipeline-started    │                 │      │       │
       │◄──────────────────────┼─────────────────┼──────┤       │
       │                       │                 │      │       │
       │                       │                 │      │ execute
       │                       │                 │      │ phases
       │   phase-completed     │                 │      │       │
       │◄──────────────────────┼─────────────────┼──────┤       │
       │                       │                 │      │       │
       │   subtask-generated   │                 │      │       │
       │◄──────────────────────┼─────────────────┼──────┤       │
       │                       │                 │      │       │
       │   pipeline-completed  │                 │      │       │
       │◄──────────────────────┼─────────────────┼──────┘       │
       │                       │                 │              │
```

## Data Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Data Flow                                   │
└─────────────────────────────────────────────────────────────────────┘

    Input                 Processing              Output
     │                        │                     │
     ▼                        ▼                     ▼
┌──────────┐          ┌──────────────┐       ┌──────────┐
│  Task    │          │ Decomposition│       │ Subtasks │
│  Description       │               │       │  Array   │
│  {                 │ • Parse       │       │  [       │
│   title,           │ • Categorize  │       │   {      │
│   description      │ • Structure   │       │    cat.  │
│  }                 │               │       │    title │
└────┬─────┘          └──────┬───────┘       │    desc  │
     │                       │               │    reqs  │
     │                       ▼               │   }, ...│
     │              ┌──────────────┐         │  ]       │
     │              │  Enrichment  │         └────┬─────┘
     │              │              │              │
     │              │ • Tech stack │              ▼
     │              │ • Standards  │       ┌──────────┐
     │              │ • Practices  │       │  Prompts │
     │              │              │       │  [       │
     │              └──────┬───────┘       │   "Data  │
     │                     │               │    Model │
     └─────────────┐       │               │    Impl" │
                   │       ▼               │   "Service
                   │  ┌──────────────┐     │    Layer"│
                   │  │   Prompt     │     │   ...    │
                   │  │  Generation  │     │  ]       │
                   │  │              │     └──────────┘
                   │  │ • Format     │
                   │  │ • Context    │
                   │  │ • Guidelines │
                   │  └──────────────┘
                   │
                   ▼
              ┌──────────┐
              │ Pipeline │
              │ Context  │
              │ {        │
              │  rules,  │
              │  stack,  │
              │  standards
              │ }        │
              └──────────┘
```

## Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Error Handling Flow                             │
└─────────────────────────────────────────────────────────────────────┘

                   ┌──────────────┐
                   │  Job Fails   │
                   └──────┬───────┘
                          │
                    ┌─────▼──────┐
                    │ Retry?     │
                    └─┬────────┬─┘
                      │Yes     │No
          ┌───────────▼──┐     │
          │ Retry Count  │     │
          │ < MaxRetries?│     │
          └─┬──────────┬─┘     │
            │Yes       │No     │
    ┌───────▼───┐      │       │
    │ Calculate │      │       │
    │ Backoff   │      │       │
    └───────┬───┘      │       │
            │          │       │
    ┌───────▼───┐      │       │
    │  Retry    │      │       │
    │  Job      │      │       │
    └───────────┘      │       │
                       │       │
                   ┌───▼───────▼──┐
                   │  Move to     │
                   │  Dead Letter │
                   │  Queue       │
                   └───────┬──────┘
                           │
                   ┌───────▼──────┐
                   │  Notify      │
                   │  Admin       │
                   └───────┬──────┘
                           │
                   ┌───────▼──────┐
                   │  Rollback?   │
                   └─┬──────────┬─┘
                     │Yes       │No
             ┌───────▼──┐       │
             │ Restore  │       │
             │Checkpoint│       │
             └──────────┘       │
                                │
                        ┌───────▼──────┐
                        │  Mark Failed │
                        └──────────────┘
```

---

**Generated**: October 31, 2025  
**Version**: 1.0.0
